#!/bin/bash
#
# Verify `sgl_mk_dest'.
#
# @author Adam Smith <adam@imaginate.life> (http://imaginate.life)
# @copyright 2016 Adam A Smith <adam@imaginate.life> (http://imaginate.life)
################################################################################

################################################################################
## SETUP ENV
################################################################################

# Define src and dest file paths.
local src="${HOME}/source.sgl.file"
local dest1="${HOME}/dest.sgl.file"
local dest2='/tmp/dest.sgl.file'

# Stop tests if a test file already exists.
[[ -f "${src}"   ]] && stop "src file \`${src}' already exists tests stopped"
[[ -f "${dest1}" ]] && stop "dest file \`${dest1}' already exists tests stopped"
[[ -f "${dest2}" ]] && stop "dest file \`${dest2}' already exists tests stopped"

# Make the test src file.
cat <<'EOF' > "${src}"
# SOURCE
# @dest $HOME/dest.sgl.file
# @dest ${TMP}/dest.sgl.file
# @mode 0755
# ...
EOF

################################################################################
## RUN FUNCTION
################################################################################

######################################################################
# @note-for-bash-newbies
# @lines 48-52
#
# The `while' loop is used to catch and register any errors from
# `sgl_mk_dest'. The following is an ordered sequence of events:
# - The `stderr' from `sgl_mk_dest' is redirected to `stdout'.
# - The original `stdout' for `sgl_mk_dest' is redirected and closed.
# - `sgl_mk_dest' is executed within a here document that captures the 
#   redirected `stderr' and sets it as the `stdin' for `read'.
# - Each line is read and any errors are thrown until `stdin' closes.
######################################################################
while IFS= read -r line; do
  [[ -n "${line}" ]] && throw "${line}"
done <<EOF
$(sgl mk_dest -d 'TMP=/tmp' "${src}" 3>&2 2>&1 1>&3-)
EOF

################################################################################
## CHECK RESULTS
################################################################################

# Catch a missing dest file.
[[ -f "${dest1}" ]] || throw "missing dest file \`${dest1}'"
[[ -f "${dest2}" ]] || throw "missing dest file \`${dest2}'"

# Catch a non-executable dest file.
[[ -x "${dest1}" ]] || throw "invalid file mode for dest file \`${dest1}'"
[[ -x "${dest2}" ]] || throw "invalid file mode for dest file \`${dest2}'"

# Catch incorrect dest file content.
if [[ -f "${dest1}" ]] && [[ "$(cat "${src}")" != "$(cat "${dest1}")" ]]; then
  throw "invalid dest file \`${dest1}'"
fi
if [[ -f "${dest2}" ]] && [[ "$(cat "${src}")" != "$(cat "${dest2}")" ]]; then
  throw "invalid dest file \`${dest2}'"
fi

################################################################################
## CLEAN ENV
################################################################################

[[ -f "${src}"   ]] && rm "${src}"
[[ -f "${dest1}" ]] && rm "${dest1}"
[[ -f "${dest2}" ]] && rm "${dest2}"
